# 뿌리오 카카오톡 알림톡 통합 가이드

## 개요
회원가입, 핸드폰 본인인증, 대회신청, 입금 확인 등 주요 이벤트 발생 시 뿌리오 API를 통해 카카오톡 알림톡을 자동으로 발송하는 시스템을 구축합니다.

---

## 뿌리오 서비스 개요

### 제공 서비스
- **카카오톡 알림톡**: 기업이 고객에게 발송하는 공식 메시지
- **SMS/LMS/MMS**: 일반 문자 서비스 (대체 발송용)
- **운영사**: 코스피 상장기업 다우기술

### 요금 정보
- 월별 전송량 구간 요금제 (실패 건 100% 환급)
- 기본요금 없음 (건당 과금)
- 후불제 당일 이용 가능

---

## 사전 준비사항

### 1. 뿌리오 가입 및 설정

#### 단계별 절차
```
1. 회원가입
   https://www.ppurio.com → 회원가입
   휴대폰 본인인증 완료

2. 기업회원 전환 (필수)
   API 연동을 위해 필수 단계
   담당자 정보 입력 및 약관 동의
   승인: 영업일 1~2일 소요

3. API 연동 신청
   연동 신청 페이지에서 개발 담당자 정보 입력
   승인: 영업일 1~2일 소요

4. 발신프로필 등록
   카카오톡 알림톡 발송을 위한 사업자 프로필
   사업자등록증 등 서류 제출
   카카오 심사: 1~2일 소요

5. 템플릿 등록
   발송할 메시지 템플릿 작성
   카카오 심사: 1~2일 소요
   템플릿 코드 발급 후 사용 가능
```

### 2. 필요한 정보

#### 발급받아야 할 정보
- **계정 ID**: 뿌리오 로그인 아이디
- **인증키(API Key)**: API 연동에 사용
- **템플릿 코드**: 각 메시지 유형별로 발급
  - 회원가입 완료
  - 대회신청 완료
  - 입금 확인 완료
  - 신청 취소 확인

---

## API 사용 방법

### 1. 인증 방식

#### 액세스 토큰 발급
```
1단계: 계정:인증키를 Base64로 인코딩
  예: "myid:myapikey" → Base64 인코딩

2단계: 토큰 발급 API 호출
  POST https://api.ppurio.com/v1/token
  Authorization: Basic {Base64_인코딩값}

3단계: 액세스 토큰 수신
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 86400  // 24시간
  }

4단계: 이후 API 호출 시 사용
  Authorization: Bearer {액세스_토큰}
```

**중요**: 토큰은 24시간 유효하므로 캐싱하여 재사용 권장

### 2. 알림톡 발송 API

#### 엔드포인트
```
POST https://api.ppurio.com/v1/kakao
Content-Type: application/json
Authorization: Bearer {액세스_토큰}
```

#### 요청 본문 구조
```json
{
  "account": "뿌리오_계정ID",
  "messageType": "ALT",  // ALT: 알림톡
  "from": "발신프로필키",
  "content": {
    "templateCode": "등록한_템플릿_코드",
    "messages": [
      {
        "to": "수신자_전화번호",  // 예: "01012345678"
        "content": "메시지 본문",
        "kakaoOptions": {
          "pfId": "발신프로필ID",
          "templateId": "템플릿ID",
          "variables": {
            "#{변수1}": "대체값1",
            "#{변수2}": "대체값2"
          }
        }
      }
    ]
  },
  "refKey": "참조키"  // 선택사항, 로그용
}
```

#### 메시지 타입
- **ALT**: 기본 알림톡
- **ALI**: 이미지형 알림톡
- **ALH**: 하이라이트형 알림톡
- **ALL**: 리스트형 알림톡

### 3. 템플릿 변수

#### 지원 기능
- 변수 최대 8개까지 사용 가능
- 변수 형식: `#{변수명}`
- 실제 발송 시 변수를 실제 값으로 대체

#### 예시 템플릿
```
안녕하세요 #{이름}님,

#{대회명} 대회 신청이 완료되었습니다.

- 신청 거리: #{거리}
- 참가비: #{참가비}원
- 입금 계좌: 하나은행 734-910008-72504
- 입금자명: #{입금자명}

입금 확인 후 참가가 확정됩니다.

감사합니다.
```

### 4. 실패 시 대체 발송

#### SMS/LMS 자동 대체
카카오톡 발송 실패 시 (카톡 미사용자 등) 자동으로 SMS/LMS로 대체 발송 가능

```json
{
  "content": {
    "messages": [
      {
        "to": "01012345678",
        "content": "알림톡 내용",
        "smsKind": "L",  // L: LMS, S: SMS
        "smsContent": "대체 문자 내용",
        "from": "발신번호"  // 등록된 발신번호
      }
    ]
  }
}
```

---

## 통합 위치 및 시나리오

### 1. 회원가입 완료 (높은 우선순위)

#### 발송 시점
- 파일: `src/components/MembershipForm.tsx`
- 위치: 회원가입 DB 저장 성공 직후

#### 발송 정보
```typescript
{
  수신자: 가입자 휴대폰번호 (users.phone)
  템플릿: "회원가입_완료"
  변수: {
    "#{이름}": users.name,
    "#{아이디}": users.user_id,
    "#{등급}": users.grade,  // 치타/말/늑대/거북/볼트
    "#{가입일시}": created_at
  }
}
```

#### 메시지 예시
```
안녕하세요 #{이름}님,

러닝브레이커 회원가입이 완료되었습니다.

- 아이디: #{아이디}
- 등급: #{등급}
- 가입일시: #{가입일시}

이제 모든 대회에 신청하실 수 있습니다.

감사합니다.
```

### 2. 대회 신청 완료 (높은 우선순위)

#### 발송 시점
- 파일: `src/components/MemberRegistrationForm.tsx` (회원)
- 파일: `src/components/RegistrationLookup.tsx` (비회원)
- 위치: 신청 DB 저장 성공 직후

#### 발송 정보
```typescript
{
  수신자: registrations.phone
  템플릿: "대회신청_완료"
  변수: {
    "#{이름}": registrations.name,
    "#{대회명}": competitions.title,
    "#{거리}": registrations.distance,
    "#{참가비}": registrations.entry_fee,
    "#{입금자명}": registrations.depositor_name,
    "#{신청번호}": registrations.id (UUID 앞 8자리)
  }
}
```

#### 메시지 예시
```
안녕하세요 #{이름}님,

#{대회명} 대회 신청이 완료되었습니다.

▶ 신청 정보
- 신청번호: #{신청번호}
- 참가 거리: #{거리}
- 참가비: #{참가비}원

▶ 입금 안내
- 계좌: 하나은행 734-910008-72504
- 예금주: (주)러닝브레이커
- 입금자명: #{입금자명}

입금 확인 후 참가가 확정됩니다.

감사합니다.
```

### 3. 입금 확인 완료 (최고 우선순위) ⭐

#### 발송 시점
- 파일: `src/app/api/bankda/confirm-payment/route.ts`
- 위치: `payment_status = 'confirmed'` 업데이트 직후

#### 발송 정보
```typescript
{
  수신자: registrations.phone
  템플릿: "입금확인_완료"
  변수: {
    "#{이름}": registrations.name,
    "#{대회명}": competitions.title,
    "#{거리}": registrations.distance,
    "#{참가비}": registrations.entry_fee,
    "#{대회일자}": competitions.date,
    "#{대회장소}": competitions.location
  }
}
```

#### 메시지 예시
```
안녕하세요 #{이름}님,

#{대회명} 참가비 입금이 확인되었습니다.

▶ 대회 정보
- 일시: #{대회일자}
- 장소: #{대회장소}
- 참가 거리: #{거리}
- 참가비: #{참가비}원 (확인완료)

대회 당일 뵙겠습니다!

감사합니다.
```

**중요**: 이 단계가 사용자에게 가장 중요한 알림이며, BankDA 자동 입금 확인 시스템과 연동하여 자동 발송됩니다.

### 4. 신청 취소 (중간 우선순위)

#### 발송 시점
- 파일: `src/components/RegistrationLookup.tsx`
- 위치: 신청 취소(DELETE) 성공 직후

#### 발송 정보
```typescript
{
  수신자: registrations.phone (취소 전 조회)
  템플릿: "신청취소_완료"
  변수: {
    "#{이름}": registrations.name,
    "#{대회명}": competitions.title,
    "#{취소일시}": new Date().toISOString()
  }
}
```

#### 메시지 예시
```
안녕하세요 #{이름}님,

#{대회명} 대회 신청이 취소되었습니다.

취소 일시: #{취소일시}

환불은 영업일 기준 3~5일 소요됩니다.

감사합니다.
```

### 5. 핸드폰 본인인증 (신규 기능, 낮은 우선순위)

#### 현재 상태
**미구현** - 생년월일과 주민번호 뒷자리로만 회원 구분

#### 구현 시 시나리오
```
1. 회원가입 폼에서 휴대폰 번호 입력

2. "본인인증" 버튼 클릭

3. 뿌리오 API로 인증번호 SMS 발송
   POST /v1/message (SMS)
   메시지: "인증번호 [123456]를 입력하세요."

4. 사용자가 인증번호 입력

5. 인증 확인 후 가입 진행
```

#### 필요 작업
- 회원가입 폼 수정 (본인인증 단계 추가)
- 인증번호 생성 및 검증 로직
- 세션 또는 Redis에 인증번호 임시 저장 (5분 유효)
- 인증 완료 후 가입 진행

---

## 기술적 구현 가이드

### 1. 환경 변수 설정

#### `.env.local` 추가
```
# 뿌리오 API 설정
PPURIO_ACCOUNT_ID=your_account_id
PPURIO_API_KEY=your_api_key
PPURIO_SENDER_KEY=your_sender_key  # 발신프로필키
PPURIO_PROFILE_ID=your_profile_id  # 발신프로필ID

# 템플릿 코드
PPURIO_TEMPLATE_SIGNUP=SIGNUP001
PPURIO_TEMPLATE_REGISTER=REG001
PPURIO_TEMPLATE_PAYMENT=PAY001
PPURIO_TEMPLATE_CANCEL=CANCEL001
```

### 2. API 유틸리티 함수 구조

#### 추천 파일 구조
```
src/
├── lib/
│   └── ppurio.ts           # 뿌리오 API 클라이언트
├── app/
│   └── api/
│       └── notifications/
│           ├── send-kakao/route.ts      # 알림톡 발송
│           └── send-verification/route.ts  # 본인인증 SMS
```

### 3. 토큰 관리 전략

#### 옵션 1: 매번 새로 발급 (간단)
- 장점: 구현 간단
- 단점: API 호출 증가

#### 옵션 2: 메모리 캐싱 (권장)
- Next.js 서버 메모리에 토큰 저장
- 유효시간 24시간 - 1시간 = 23시간으로 설정하여 만료 전 갱신

#### 옵션 3: Redis 캐싱 (대규모)
- Redis에 토큰 저장
- 여러 서버 인스턴스 간 공유 가능

### 4. Rate Limit 고려

#### 제한사항
- **초당 15회** 제한
- 대량 발송 시 Queue 시스템 필요

#### 권장 구조
```
회원가입/신청 발생
  ↓
Message Queue (Redis Queue, Bull 등)
  ↓
Worker Process (초당 10건씩 처리)
  ↓
뿌리오 API 호출
  ↓
성공/실패 로그 저장
```

### 5. 로그 및 모니터링

#### 저장해야 할 정보
```typescript
// notifications 테이블 (Supabase)
{
  id: UUID
  type: 'signup' | 'register' | 'payment' | 'cancel'
  recipient_phone: string
  template_code: string
  variables: JSON
  status: 'pending' | 'sent' | 'failed'
  ppurio_message_id: string  // 뿌리오 응답 ID
  sent_at: timestamp
  error_message?: string
}
```

---

## 개발 단계별 체크리스트

### Phase 1: 뿌리오 계정 설정 (1~2주)
- [ ] 뿌리오 회원가입
- [ ] 기업회원 전환 신청 및 승인 대기
- [ ] API 연동 신청 및 승인 대기
- [ ] 발신프로필 등록 및 승인 대기
- [ ] 템플릿 4개 작성 및 등록
  - [ ] 회원가입 완료
  - [ ] 대회신청 완료
  - [ ] 입금확인 완료
  - [ ] 신청취소 완료
- [ ] 템플릿 심사 통과 확인
- [ ] 계정ID, API Key, 템플릿 코드 발급 확인

### Phase 2: 기본 인프라 구축 (개발 1일)
- [ ] 환경 변수 설정 (.env.local)
- [ ] 뿌리오 API 클라이언트 유틸리티 작성
  - [ ] 토큰 발급 함수
  - [ ] 알림톡 발송 함수
  - [ ] 에러 핸들링
- [ ] Supabase `notifications` 테이블 생성
- [ ] 테스트 코드 작성

### Phase 3: 핵심 기능 통합 (개발 1일)
- [ ] **입금 확인 알림** (최우선)
  - [ ] `/api/bankda/confirm-payment` 수정
  - [ ] 입금 확인 성공 시 알림톡 발송
  - [ ] 로그 저장
- [ ] **대회 신청 완료 알림**
  - [ ] 회원 신청 폼 수정
  - [ ] 비회원 신청 폼 수정
  - [ ] 알림톡 발송
- [ ] **회원가입 완료 알림**
  - [ ] 회원가입 폼 수정
  - [ ] 알림톡 발송

### Phase 4: 부가 기능 (선택사항)
- [ ] 신청 취소 알림
- [ ] 대시보드: 알림톡 발송 내역 조회
- [ ] 관리자: 수동 알림톡 발송 기능
- [ ] 본인인증 SMS (회원가입 시)

### Phase 5: 테스트 및 배포 (1일)
- [ ] 로컬 환경 테스트
- [ ] Vercel 환경변수 설정
- [ ] 프로덕션 배포
- [ ] 실제 휴대폰으로 알림톡 수신 테스트
- [ ] 모니터링 및 로그 확인

---

## 예상 비용

### 뿌리오 요금 (참고)
- 알림톡: 건당 약 8~15원
- SMS(대체 발송): 건당 약 8~28원
- LMS(대체 발송): 건당 약 26~50원

### 예상 발송량 (월간)
```
가정: 월 100명 신청
- 회원가입: 50건 × 10원 = 500원
- 대회신청: 100건 × 10원 = 1,000원
- 입금확인: 90건 × 10원 = 900원
- 신청취소: 10건 × 10원 = 100원

월 예상 비용: 약 2,500원
```

### 주의사항
- 초기 테스트 기간 동안 자주 테스트하게 되므로 소량 충전 권장
- 실패 건은 100% 환급되므로 실제 발송 성공 건만 과금

---

## 보안 및 개인정보 고려사항

### 1. 개인정보 수집 및 이용 동의
- 회원가입 시 "마케팅 정보 수신 동의" 체크박스 이미 존재
- 알림톡 발송은 "거래 관련 정보"이므로 별도 동의 불필요
- 단, 마케팅성 메시지는 동의 필요

### 2. 휴대폰 번호 유효성 검증
- 현재: 기본 형식 검증만 존재
- 권장: 010으로 시작, 10~11자리 숫자 검증

### 3. API Key 보안
- 환경 변수로 관리 (`.env.local`)
- GitHub에 절대 커밋 금지 (`.gitignore` 확인)
- Vercel 환경변수에 안전하게 저장

### 4. Rate Limit 공격 방지
- 동일 번호로 짧은 시간 내 다중 요청 방지
- Queue 시스템으로 발송 속도 제어

---

## 문제 해결 가이드

### 1. 알림톡 발송 실패

#### 원인 및 해결
```
에러: "Invalid template code"
→ 템플릿 코드 오타 확인
→ 템플릿 심사 통과 여부 확인

에러: "Invalid phone number"
→ 휴대폰 번호 형식 확인 (01012345678)
→ 국제번호 제거 (+82 제거)

에러: "Unauthorized"
→ 액세스 토큰 만료 확인
→ 토큰 재발급

에러: "Rate limit exceeded"
→ 초당 15회 제한 확인
→ Queue 시스템 도입 검토
```

### 2. 템플릿 변수 오류

#### 주의사항
- 템플릿에 정의된 변수명과 API 요청의 변수명이 정확히 일치해야 함
- 변수 개수도 일치해야 함
- 빈 값도 전달해야 함 (null 불가)

### 3. SMS 대체 발송 실패

#### 원인 및 해결
```
에러: "Invalid sender number"
→ 발신번호 사전 등록 필요
→ 뿌리오 관리자 페이지에서 등록

에러: "Content too long"
→ SMS: 최대 90바이트
→ LMS: 최대 2,000바이트
→ 한글 1글자 = 2바이트
```

---

## 요약

### 뿌리오 통합의 핵심
1. **사전 준비**: 기업회원 전환 → API 연동 신청 → 발신프로필 등록 → 템플릿 등록 (총 1~2주)
2. **인증 방식**: 계정:API키 Base64 인코딩 → 토큰 발급 (24시간) → Bearer 토큰 사용
3. **발송 방식**: POST /v1/kakao → 템플릿 코드 + 변수 전달 → 알림톡 발송
4. **통합 위치**:
   - 회원가입 완료 시
   - 대회 신청 완료 시
   - **입금 확인 시 (최우선)**
   - 신청 취소 시

### 개발 우선순위
1. **입금 확인 알림** (사용자 가치 최고)
2. 대회 신청 완료 알림
3. 회원가입 완료 알림
4. 신청 취소 알림
5. 본인인증 SMS (선택)

### 기술 스택
- Next.js API Routes
- 뿌리오 REST API
- Supabase (로그 저장)
- 환경 변수 관리

---

## 다음 단계

코드 작성이 필요할 때 다음 작업을 진행합니다:

1. `src/lib/ppurio.ts` - API 클라이언트 유틸리티
2. `src/app/api/notifications/send-kakao/route.ts` - 알림톡 발송 API
3. Supabase `notifications` 테이블 생성 스크립트
4. 각 이벤트 발생 지점에 알림톡 발송 코드 추가
5. 테스트 및 배포

현재는 개념 이해와 준비 단계이므로, 뿌리오 계정 설정을 먼저 완료하시면 됩니다.
